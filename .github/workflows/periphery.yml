name: Periphery

on:
  pull_request:
  push:
    branches: [ main ]

jobs:
  periphery:
    name: Run Periphery
    runs-on:  macos-26

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Periphery
      run: brew install periphery

    - name: Run Periphery
      run: periphery scan --format github-markdown --write-results periphery.md
    
    - name: Add Periphery results to summary
      run: |
        echo "## ðŸ§¹ Periphery Unused Code Report" >> $GITHUB_STEP_SUMMARY
        cat periphery.md >> $GITHUB_STEP_SUMMARY

    - name: Read markdown into output
      id: periphery
      run: |
        echo "report<<EOF" >> $GITHUB_OUTPUT
        cat periphery.md >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: Find Comment
      uses: peter-evans/find-comment@v3
      id: fc
      with:
        issue-number: ${{ github.event.pull_request.number }}
        comment-author: 'github-actions[bot]'
        body-includes: ðŸ§¹ Periphery Unused Code Report

    - name: Create or update comment
      uses: peter-evans/create-or-update-comment@v5
      with:
        comment-id: ${{ steps.fc.outputs.comment-id }}
        issue-number: ${{ github.event.pull_request.number }}
        body: |
          ## ðŸ§¹ Periphery Unused Code Report
          ${{ steps.periphery.outputs.report }}
        edit-mode: replace